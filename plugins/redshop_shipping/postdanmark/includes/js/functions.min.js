"use strict";(function(b,d){var a=b.redSHOP;if(typeof a.Shipping==="undefined"){a.Shipping={}}var c={version:"1.0.0",isMobile:(screen.width<=480),useMap:true,ajaxIndex:"index.php",country:"DK",servicePoints:{},shippingZipcode:5000};c.isPostDanmarkInput=function(e){var f=d(e).get(0).getAttribute("onclick");return(f.length>1&&f.match(/'postdanmark'/)!=null)};c.formValidate=function(){if(typeof d('input[name="service_point_id"]').val()!="undefined"){if(d('input[name="service_point_id"]').val()==""){return false}if(d("#mapMobileSeachBox").length!=0){return d("#mapMobileSeachBox").val()!=""}if(d("#shop_id_pacsoft").length!=0){return d("#shop_id_pacsoft").val()!=""}}return true};c.loadLocationMobile=function(e){d("#mapMobileSeachBox").select2({ajax:{url:c.ajaxIndex+"?option=com_redshop&view=checkout&task=getShippingInformation&tmpl=component&plugin=PostDanmark",dataType:"json",delay:250,data:function(f,g){return{zipcode:f,countryCode:c.country}},results:function(h,g){var f=[];d.each(h.addresses,function(l,i){var j='<div class="row-fluid"><div class="span10">';j+="<div>"+h.name[l]+"</div>";j+="<div>"+h.city[l]+" "+h.postalCode[l]+"</div>";j+="<div>"+i+"</div>";j+="</div></div>";var k={id:h.servicePointId[l]+"|"+h.name[l]+"|"+i+"|"+h.postalCode[l]+"|"+h.city[l],text:j,name:h.name[l],poingId:h.servicePointId[l],addresses:i,postalCode:h.postalCode[l],city:h.city[l]};f.push(k)});return{results:f}},cache:true},escapeMarkup:function(f){return f},containerCssClass:"span4",minimumInputLength:4})};c.showForm=function(){jQuery.magnificPopup.open({items:{src:d("#showMap")},type:"inline",enableEscapeKey:false,modal:true,showCloseBtn:false,callbacks:{open:function(){}}},0);c.magnificPopup=jQuery.magnificPopup.instance;c.ajaxGetShippingZipcode(function(){c.ajaxGetShippingInformation(c.shippingZipcode,function(){if(c.useMap){c.drawMap()}})})};c.getMapHtml=function(){var e='<meta name="viewport" content="initial-scale=1.0, user-scalable=no">';e+='<div id="showMap" class="white-popup mfp-hide">';e+='    <span id="mapMessage"></span>';e+='    <input type="text" id="mapSeachBox" maxlength="4" placeholder="'+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_ENTER_POSTAL_CODE")+'" />';e+='    <img src="'+a.RSConfig._("SITE_URL")+'plugins/redshop_shipping/postdanmark/includes/images/postdanmark-logo.png" id="pd-logo"/>';e+='    <div id="map_canvas" style="height: 350px; width: 780px; position: relative; margin-top: 20px;"></div>';e+='    <div id="pickupLocations" class="pickupLocation-container">';e+='        <div class="map_buttons">';e+='        <div class="map-button-save">';e+="            <span>";e+="                <span>"+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_OK")+"</span>";e+="            </span>";e+="        </div>";e+='        <div class="map-button-close">';e+="            <span>";e+="                <span>"+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_CANCEL")+"</span>";e+="            </span>";e+="        </div>";e+="    </div>";e+='        <div id="postdanmark_list"></div>';e+='        <div class="clear"></div>';e+='    <div class="map_buttons">';e+='        <div class="map-button-save" style="margin-left: 10px;">';e+="            <span>";e+="                <span>"+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_OK")+"</span>";e+="            </span>";e+="        </div>";e+='        <div class="map-button-close">';e+="            <span>";e+="                <span>"+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_CANCEL")+"</span>";e+="            </span>";e+="        </div>";e+="    </div>";e+="    </div>";e+="</div>";return e};c.drawMap=function(){if(typeof c.servicePoints==="object"){if(!typeof c.servicePoints.addresses==="undefined"){initMap(c.servicePoints.addresses,c.servicePoints.name,c.servicePoints.number,c.servicePoints.opening,c.servicePoints.close,c.servicePoints.opening_sat,c.servicePoints.close_sat,c.servicePoints.lat,c.servicePoints.lng,c.servicePoints.servicePointId);d("#postdanmark_list").html(c.servicePoints.radio_html)}}};c.injectButton=function(f){if(c.useMap){if(d("#sp_info").length==0){d(f).parent().after('<div id="postdanmark_html_inject"><input type="button" class="btn btn-small" onclick="redSHOP.Shipping.postDanmark.showForm()" value="'+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_CHOOSE_DELIVERY_POINT")+'"  alt="#TB_inline?width=790&amp;inlineId=showMap" id="showMap_input" /><input type="hidden" name="shop_id" id="shop_id_pacsoft" value="" /><div id="sp_info"><span id="sp_name"></span><span id="sp_address"></span></div><div id="sp_inputs"><input type="hidden" name="service_point_id" value="" /><input type="hidden" name="service_point_id_name" value="" /><input type="hidden" name="service_point_id_address" value="" /><input type="hidden" name="service_point_id_city" value="" /><input type="hidden" name="service_point_id_postcode" value="" /></div>'+c.getMapHtml()+"</div>")}}else{if(d("#postdanmark_html_inject").length==0){var e='<input name="shop_id" id="mapMobileSeachBox" type="hidden" placeholder="'+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_ENTER_POSTAL_CODE")+'" maxlength="4">';d(f).parent().after('<div id="postdanmark_html_inject">'+e+"</div>");c.loadLocationMobile(f)}}};c.ajaxGetShippingZipcode=function(e){d.ajax({url:c.ajaxIndex,data:{option:"com_redshop",view:"account_shipto",task:"addshipping","return":"com_redshop",tmpl:"component","for":"true",infoid:d('input[name="users_info_id"]:checked').val(),Itemid:1},method:"POST"}).done(function(g,h,f){c.shippingZipcode=d("#zipcode_ST",g).val();if(typeof e==="function"){e(g,h,f)}})};c.ajaxGetShippingInformation=function(e,f){d.ajax({url:c.ajaxIndex,data:{option:"com_redshop",view:"checkout",task:"getShippingInformation",tmpl:"component",plugin:"PostDanmark",zipcode:parseInt(e),countryCode:c.country},method:"GET",dataType:"json"}).done(function(h,i,g){c.servicePoints=h;if(typeof f==="function"){f(h,i,g)}}).fail(function(){})};c.init=function(){if(d('input[value="postdanmark_postdanmark"]').attr("checked")==="checked"||d('input[value="postdanmark_postdanmark"]').attr("type")=="hidden"){c.injectButton(d('input[value="postdanmark_postdanmark"]').parent().parent())}d('input[type="radio"][id^="shipping_rate_id"]').click(function(){if(c.isPostDanmarkInput(d(this))){c.injectButton(d(this))}else{d("#showMap_input, #sp_info, #sp_inputs, #showMap, #postdanmark_html_inject").remove()}});var e=d("body");e.on("click",".moduleRowSelected",function(f){if(d('input[value="postdanmark_postdanmark"]',d(this)).length>0){if(d("#showMap_input").length===0){c.injectButton(d(this))}}else{d("#showMap_input, #sp_info, #showMap, #sp_inputs, #thickbox-css, .pn_error").remove()}});c.hooks()};c.hooks=function(){d('input[type="radio"]').on("click","input",function(f){if(c.isPostDanmarkInput(this)&&d(this).attr("checked")&&d("#showMap_input").length===0){c.injectButton(this)}});if(c.useMap){d("body").on("click",".map-button-save",function(){d(".pn_error").remove();if(!d('input[name="postdanmark_pickupLocation"]').is(":checked")){if(d("#error_checked_radio").length===0){d(".map_buttons").before('<span id="error_checked_radio" style="color: red; position: absolute; left: 200px;">'+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_SELECT_ONE_OPTION")+"</span>")}}else{if(d("#error_checked_radio").length>0){d("#error_checked_radio").remove()}var j=d('input[name="postdanmark_pickupLocation"]:checked').val();var h=d('input[id="'+j+'"]').parent().parent();var f=d(".point_info > strong",h).html();var k=d('input[id="'+j+'"]').val(),g=d(".point_info > strong",h).html(),i=d(".postdanmark_address > .street",h).html(),e=d(".postdanmark_address > .city",h).html(),l=d(".postdanmark_address > .service_postcode",h).val();d("input[name='service_point_id']").val(k);d("input[name='service_point_id_name']").val(g);d("input[name='service_point_id_address']").val(i);d("input[name='service_point_id_city']").val(e);d("input[name='service_point_id_postcode']").val(l);d("#sp_info #sp_name").html(f+", ");d("#sp_info #sp_address").html(i+" "+e+" "+l);d("#shop_id_pacsoft").val(k+"|"+g+"|"+i+"|"+l+"|"+e);d.magnificPopup.close()}});d("body").on("click",".map-button-close",function(){jQuery.magnificPopup.close()});d("body").on("keyup","#mapSeachBox",function(){if(d(this).val().length===4){var e=d(this).val();d(this).attr("placeholder","SÃ¸ger, Vent venligst...");d(this).val("").attr("disabled","disabled");c.ajaxGetShippingInformation(e,function(){d("#mapSeachBox").attr("placeholder",Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_ENTER_POSTAL_CODE")).removeAttr("disabled");c.drawMap()})}})}if(c.isPostDanmarkInput(jQuery('input[name="shipping_rate_id"]:checked'))){d('input[name="checkoutnext"], input[name="checkout_final"]').on("click","input",function(f){d(".pn_error").remove();if(c.formValidate()){d("form#adminForm").submit()}else{d("#sp_info").after('<div class="pn_error" style="color: red; font-weight: normal; ">'+Joomla.JText._("PLG_REDSHOP_SHIPPING_POSTDANMARK_PRESS_POINT_TO_DELIVERY")+"</div>");f.preventDefault()}})}};a.Shipping.postDanmark=c;d(document).ready(function(){c.init()})})(window,jQuery);