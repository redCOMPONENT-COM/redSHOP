!function(e,t,i,n){function a(t,i){this._name=o,this._defaults=d,this.element=t,this.options=e.extend({},d,i),this.token=null,this.dropzoneInstance=null,this.$container=e(t),this.$dropzonePreview=this.$container.find(".rs-media-dropzone-preview"),this.$dropzoneForm=this.$container.find(".rs-media-dropzone-form"),this.$alertModal=this.$container.find(".rs-media-alert-modal"),this.$cropperModal=this.$container.find(".rs-media-cropper-modal"),this.$cropperButton=this.$container.find(".rs-media-cropper-btn"),this.$removeButton=this.$container.find(".rs-media-remove-btn"),this.$target=this.$container.find(".redshop-media-img-select"),this.$mediaFileButton=null,this.$mediaFileInsertButton=null,this.$mediaFileModal=null,this.$mediaFilePreview=null,this.$mediaFileDelModal=null,this.init()}var o="redshopMedia",d={uploadUrl:"index.php?option=com_redshop&view=media&task=ajaxUpload",deleteUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",allowedMime:"image/jpeg,image/jpg,image/png,image/gif",maxFileSize:2048,initFile:null,showMediaFiles:!1};a.prototype={init:function(){var t=this;if(this._initAttributes(),Dropzone.autoDiscover=!1,t.$dropzoneForm.length&&e("body").append(e(t.$dropzoneForm[0]).html()),e("#"+t.$container.data("id")+"-dropzone")&&(t.dropzoneInstance=new Dropzone("#"+t.$container.data("id")+"-dropzone",{url:t.options.uploadUrl,autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:e(t.$dropzonePreview[0]).html()})),t.$alertModal.length&&(t.$alertModal=e(t.$alertModal[0])),t.$cropperButton.length&&(t.$cropperButton=e(t.$cropperButton[0])),t.$removeButton.length&&(t.$removeButton=e(t.$removeButton[0])),t.$target.length&&(t.$target=e(t.$target[0])),1==t.options.showMediaFiles&&(t.$container.find(".rs-media-gallery-modal").length&&(t.$mediaFileModal=e(t.$container.find(".rs-media-gallery-modal")[0])),t.$container.find(".rs-media-gallery-preview").length&&(t.$mediaFilePreview=e(t.$container.find(".rs-media-gallery-preview")[0])),t.$container.find(".rs-media-gallery-delete-modal").length&&(t.$mediaFileDelModal=e(t.$container.find(".rs-media-gallery-delete-modal")[0])),t.$container.find(".rs-media-gallery-btn").length&&(t.$mediaFileButton=e(t.$container.find(".rs-media-gallery-btn")[0])),t.$container.find(".rs-media-gallery-insert-btn").length&&(t.$mediaFileInsertButton=e(t.$container.find(".rs-media-gallery-insert-btn")[0])),this._initMediaFileEvents()),this._initEvents(),null!=t.options.initFile){var i=t.dataURItoBlob(t.options.initFile.blob);i.name=t.options.initFile.name,t.dropzoneInstance.emit("thumbnail",t.options.initFile,t.options.initFile.url),t.dropzoneInstance.addFile(i)}},_initAttributes:function(){this.token=this.$container.attr("data-token")},_initEvents:function(){var t=this;t.dropzoneInstance.on("addedfile",function(i){return e("#toolbar-apply button, #toolbar-save button, #toolbar-save-new button, #toolbar-save-copy button").attr("disabled",!0),t.validateFile(i)?(this.files.length>1&&this.removeFile(this.files[0]),t.$cropperButton.removeClass("disabled").prop("disabled",!1),t.$removeButton.removeClass("disabled").prop("disabled",!1),void(t.$container.find("#rs-media-img-delete").length&&t.$container.find("#rs-media-img-delete").remove())):void this.removeFile(i)}),t.dropzoneInstance.on("success",function(i,n){n=JSON.parse(n),n.success&&t.$target.val(n.data.file.url),e("#toolbar-apply button, #toolbar-save button, #toolbar-save-new button, #toolbar-save-copy button").attr("disabled",!1)}),t.$removeButton.on("click",function(i){i.preventDefault(),t.dropzoneInstance.removeAllFiles(),t.$target.val(""),t.$cropperButton.addClass("disabled").prop("disabled",!0),t.$removeButton.addClass("disabled").prop("disabled",!0);var n=null;t.$container.find("#rs-media-img-delete").length<=0&&(n=e("<input/>"),n.attr("id","rs-media-img-delete").attr("name",t.$container.data("id")+"_delete").attr("type","text"),e("#adminForm").append(n)),n.val(!0)}),t.$cropperButton.on("click",function(e){e.preventDefault();var i=t.dropzoneInstance.files[0];return i?void(i.width<100||t.$cropperModal.modal("show")):void showAlert("Please insert an image!!!")}),t.$cropperModal.on("shown.bs.modal",function(e){var i=t.dropzoneInstance.files[0],n=i.name,a=t.$cropperModal.find(".crop-upload"),o=t.$cropperModal.find(".image-container img").first(),d=new FileReader;d.onloadend=function(){o.attr("src",d.result),o.cropper("destroy").cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,viewMode:3,zoomable:!0})},i.preload?d.readAsDataURL(t.dataURItoBlob(i.blob)):d.readAsDataURL(i),a.off("click"),a.on("click",function(){var e=o.cropper("getCroppedCanvas").toDataURL(),a=t.dataURItoBlob(e);a.cropped=!0,a.name=n,t.dropzoneInstance.removeFile(i),t.dropzoneInstance.addFile(a),t.$cropperModal.modal("hide")})})},_initMediaFileEvents:function(){var t=this;t.$mediaFileButton.click(function(e){e.preventDefault(),t.$mediaFileModal.modal("show")}),t.$mediaFileModal.find(".img-obj").click(function(i){i.preventDefault(),e(this).hasClass("selected")?e(this).removeClass("selected"):(t.$mediaFileModal.find(".img-obj").removeClass("selected"),e(this).addClass("selected"),t.mediaFileShowInfor(this)),t.mediaFileResetPreview(),t.mediaFileToggleInsert()}),t.$mediaFileInsertButton.click(function(e){e.preventDefault();var i=t.$mediaFileModal.find(".img-obj.selected").find("img").first(),n=i.attr("src");t.$target.val(n);var a=new XMLHttpRequest;a.open("GET",n),a.responseType="blob",a.send(),a.addEventListener("load",function(){var e=new FileReader;e.readAsDataURL(this.response),e.addEventListener("loadend",function(){var n=t.dataURItoBlob(e.result);n.name=i.attr("alt"),t.dropzoneInstance.addFile(n),t.$mediaFileModal.modal("hide")})})}),t.$mediaFileModal.find(".btn-del-g").on("click",function(i){i.preventDefault(),t.$mediaFileDelModal.find(".btn-confirm-del-g").data("id",e(this).data("id")),t.$mediaFileDelModal.modal("show")}),t.$mediaFileDelModal.find(".btn-confirm-del-g").on("click",function(i){i.preventDefault();var n=e(this).data("id");n&&e.ajax({url:t.options.deleteUrl,method:"post",data:{id:n}}).done(function(e){t.$mediaFileModal.find(".img-obj.selected").parent().remove(),t.$mediaFileModal.find(".pv-wrapper").addClass("hidden")}).always(function(e){t.$mediaFileDelModal.modal("hide")})})},validateFile:function(e){var t=this,i=e.size/1024;return i>t.options.maxFileSize?(t.showAlert(Joomla.JText._("COM_REDSHOP_UPLOAD_FILE_TOO_BIG")),!1):-1==t.options.allowedMime.indexOf(e.type)?(t.showAlert(Joomla.JText._("COM_REDSHOP_MEDIA_ERROR_FILE_UPLOAD_INVALID")),!1):!0},showAlert:function(t){var i=this;i.$alertModal.find(".alert-text").text(t),i.$alertModal.modal("show"),e("#toolbar-apply button, #toolbar-save button, #toolbar-save-new button, #toolbar-save-copy button").attr("disabled",!1)},dataURItoBlob:function(e){for(var t=atob(e.split(",")[1]),i=new ArrayBuffer(t.length),n=new Uint8Array(i),a=0;a<t.length;a++)n[a]=t.charCodeAt(a);return new Blob([i],{type:"image/jpg"})},mediaFileShowInfor:function(t){var i=this;if(!(i.$mediaFileModal.find(".preview-pane").length<=0)){var n=e(i.$mediaFileModal.find(".preview-pane")[0]),a=e(t).find(".img-type"),o={id:a.data("id"),url:a.attr("src"),name:a.attr("alt"),size:a.data("size"),dimension:a.data("dimension")},d=a.clone();n.find(".pv-img .img-type").remove(),n.find(".pv-img").append(d),n.find(".pv-zoom").attr("href",o.url),n.find(".pv-zoom").attr("data-title",o.name),n.find(".pv-link").attr("href",o.url),n.find(".pv-name").text(o.name),n.find(".pv-size").text(o.size),n.find(".pv-dimension").text(o.dimension),n.find(".pv-url").html('<input type="text" value="'+o.url+'" class="form-control" readonly="true">'),n.find(".pv-remove > a").data("id",o.id),n.find(".pv-wrapper").removeClass("hidden")}},mediaFileResetPreview:function(){var t=this;if(!(t.$mediaFileModal.find(".preview-pane").length<=0)){var i=e(t.$mediaFileModal.find(".preview-pane")[0]);t.$mediaFileModal.find(".img-obj.selected").length<=0&&i.find(".pv-wrapper").addClass("hidden")}},mediaFileToggleInsert:function(){var e=this;null!=e.$mediaFileModal&&(e.$mediaFileModal.find(".img-obj.selected").length>0?e.$mediaFileInsertButton.removeAttr("disabled"):e.$mediaFileInsertButton.attr("disabled","true"))}},e.fn[o]=function(t){return this.each(function(){e.data(this,"plugin_"+o)||e.data(this,"plugin_"+o,new a(this,t))})}}(jQuery,window,document);