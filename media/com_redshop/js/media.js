var rsMedia={url:"index.php?option=com_redshop&view=media&task=ajaxUpload",delUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",dropzoneFromHtml:$("#j-dropzone-form").html(),dropzoneInstance:{},galleryItems:[],cropping:function(e){$(document).on("click","button.cropping",function(t){t.preventDefault();var n=e.files[0];if(!n)return $("#alertModal").find(".alert-text").text("Please insert an image!!!"),void $("#alertModal").modal("show");if(!(n.width<100)){var a=n.name,i=$("#cropModal"),o=i.find(".crop-upload"),d=$("<img />"),l=new FileReader;l.onloadend=function(){d.attr("src",l.result),i.find(".image-container").html(d),d.cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,minContainerWidth:320,minContainerHeight:320,viewMode:3,zoomable:!1})},n.preload?l.readAsDataURL(rsMedia.dataURItoBlob(n.blob)):l.readAsDataURL(n),o.off("click"),i.modal("show"),i.trigger("resize"),console.log("abc"),o.on("click",function(){var t=d.cropper("getCroppedCanvas").toDataURL(),o=rsMedia.dataURItoBlob(t);o.cropped=!0,o.name=a,console.log(a),console.log(o),e.removeFile(n),e.addFile(o),i.modal("hide")})}})},dropzone:function(){if(Dropzone.autoDiscover=!1,$("body").append(this.dropzoneFromHtml),$("#j-dropzone").length){var e=new Dropzone("#j-dropzone",{url:rsMedia.url,autoProcessQueue:!1,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#j-dropzone-tpl").html()});this.dropzoneInstance=e,this.dropzoneEvents(this.dropzoneInstance),this.cropping(this.dropzoneInstance)}},dropzoneEvents:function(e){e.on("addedfile",function(e){return e.type.indexOf("image/")<0?(this.removeFile(e),$("#alertModal").find(".alert-text").text("You can not upload this type of file!"),void $("#alertModal").modal("show")):void(this.files.length>1&&this.removeFile(this.files[0]))}),e.on("success",function(e,t){t=JSON.parse(t),t.success&&$(".img-select").val(t.data.file.url)}),$(document).on("click","button.removing",function(t){if(e.removeAllFiles(),$(".img-select").val(""),$("#image_delete").length<=0){var n=$("<input/>");n.attr("id","image_delete").attr("name","image_delete").attr("type","hidden").val(!0),$("#adminForm").append(n[0])}})},dropzonePreload:function(e,t){t&&(newfile=rsMedia.dataURItoBlob(t.blob),newfile.name=t.name,e.emit("thumbnail",t,t.url),e.addFile(newfile))},dataURItoBlob:function(e){for(var t=atob(e.split(",")[1]),n=new ArrayBuffer(t.length),a=new Uint8Array(n),i=0;i<t.length;i++)a[i]=t.charCodeAt(i);return new Blob([n],{type:"image/jpg"})},init:function(){$.fn.modalmanager.defaults.backdropLimit=1,this.dropzone(),this.galleryEvents()},galleryDropzone:function(){if($("#g-dropzone").length){var e=new Dropzone("#g-dropzone",{url:rsMedia.url,maxFiles:1,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#g-dropzone-tpl").html()});this.galleryDropzoneEvents(e)}},galleryEvents:function(e){"undefined"!=typeof e&&""!=e||(e="galleryModal"),$(".choosing").on("click",function(t){t.preventDefault(),$("#"+e).modal("show")}),$(document).on("click","#"+e+" .img-obj",function(t){t.preventDefault(),$(this).hasClass("selected")?$(this).removeClass("selected"):($("#"+e+" .img-obj").removeClass("selected"),$(this).addClass("selected"),rsMedia.showInfoThumbnail(this)),rsMedia.resetInfoThumbnail(),rsMedia.toggleInsert()}),$("#"+e+" #type-filter").on("change",function(t){var n=$(this).val();return"all"==n?void $("#"+e+" .img-obj").parent().removeClass("hidden"):"attached"==n?void $("#"+e+" .img-obj > img:not([data-attached=true])").parent().parent().addClass("hidden"):($("#"+e+" .img-obj > img:not([data-media="+n+"])").parent().parent().addClass("hidden"),void $("#"+e+" .img-obj > img[data-media="+n+"]").parent().parent().removeClass("hidden"))}),$("#"+e+" .btn-insert").on("click",function(t){t.preventDefault();var n=$("#"+e+" .img-obj.selected").find("img").first(),a=n.attr("src");$("#"+e+" .img-select").val(a);var i=new XMLHttpRequest;i.open("GET",a),i.responseType="blob",i.send(),i.addEventListener("load",function(){var t=new FileReader;t.readAsDataURL(i.response),t.addEventListener("loadend",function(){var a=rsMedia.dataURItoBlob(t.result);a.name=n.attr("alt"),rsMedia.dropzoneInstance.addFile(a),$("#"+e).modal("hide")})})}),$("#"+e+" .btn-del-g").on("click",function(t){t.preventDefault(),$("#"+e+"Delete .btn-confirm-del-g").data("id",$(this).data("id")),$("#"+e+"Delete").modal("show")}),$("#"+e+"Delete .btn-confirm-del-g").on("click",function(t){t.preventDefault(),console.log("abc");var n=$(this).data("id");n&&$.ajax({url:rsMedia.delUrl,method:"post",data:{id:n}}).done(function(t){$("#"+e).find(".img-obj.selected").parent().remove(),$("#"+e+" .pv-wrapper").addClass("hidden")}).always(function(t){$("#"+e+"Delete").modal("hide")})})},galleryDropzoneEvents:function(e){e.on("sending",function(e,t,n){n.append("new",!0)}),e.on("success",function(t,n){n=JSON.parse(n);var t=n.data.file,a=$("#g-item-tpl").html(),i=$(a),o={};"image"==t.mime?(i.find("span.img-type").remove(),o=i.find("img.img-type")):(i.find("img.img-type").remove(),o=i.find("span.img-type")),o.attr("src","/"+t.url),o.attr("alt",t.name),o.data("id",t.id),o.data("size",t.size),o.data("dimension",t.dimension),o.data("media",t.media),i.find(".img-mime").data("mime",t.mime),""!=t.mime&&(o.find("i.fa").removeClass("fa-file-o").addClass("fa-file-"+t.mime+"-o"),i.find(".img-mime i.fa").removeClass("fa-file-o").addClass("fa-file-"+t.mime+"-o")),i.find(".img-name").text(t.name),$("#upload-lib .list-pane").append(i[0]),$('#g-tab a[href="#upload-lib"]').tab("show"),e.removeAllFiles()})},showInfoThumbnail:function(e){var t=$(e).find(".img-type"),n={id:t.data("id"),url:t.attr("src"),name:t.attr("alt"),size:t.data("size"),dimension:t.data("dimension")};$img=t.clone();var a=$(".preview-pane");a.find(".pv-img .img-type").remove(),a.find(".pv-img").append($img),a.find(".pv-zoom").attr("href",n.url),a.find(".pv-zoom").attr("data-title",n.name),a.find(".pv-link").attr("href",n.url),a.find(".pv-name").text(n.name),a.find(".pv-size").text(n.size),a.find(".pv-dimension").text(n.dimension),a.find(".pv-url").html('<input type="text" value="'+n.url+'" class="form-control" readonly="true">'),a.find(".pv-remove > a").data("id",n.id),a.find(".pv-wrapper").removeClass("hidden")},resetInfoThumbnail:function(){var e=$(".preview-pane");$(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden")},toggleInsert:function(){$(".img-obj.selected").length>0?$(".btn-insert").removeAttr("disabled"):$(".btn-insert").attr("disabled","true")}};