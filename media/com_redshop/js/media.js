var rsMedia={url:"index.php?option=com_redshop&view=media&task=ajaxUpload",delUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",dropzoneFromHtml:$("#j-dropzone-form").html(),dropzoneInstance:{},galleryItems:[],cropping:function(e){$(document).on("click","button.rs-media-cropping",function(a){a.preventDefault();var n=e.files[0];if(!n)return $("#alertModal").find(".alert-text").text("Please insert an image!!!"),void $("#alertModal").modal("show");if(!(n.width<100)){var i=n.name,t=$("#cropModal"),o=t.find(".crop-upload"),d=$("<img />"),r=new FileReader;r.onloadend=function(){d.attr("src",r.result),t.find(".image-container").html(d),d.cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,minContainerWidth:320,minContainerHeight:320,viewMode:3,zoomable:!1})},n.preload?r.readAsDataURL(rsMedia.dataURItoBlob(n.blob)):r.readAsDataURL(n),o.off("click"),t.modal("show"),t.trigger("resize"),console.log("abc"),o.on("click",function(){var a=d.cropper("getCroppedCanvas").toDataURL(),o=rsMedia.dataURItoBlob(a);o.cropped=!0,o.name=i,console.log(i),console.log(o),e.removeFile(n),e.addFile(o),t.modal("hide")})}})},dropzone:function(){Dropzone.autoDiscover=!1,$("body").append(this.dropzoneFromHtml),$("#j-dropzone").length&&(this.dropzoneInstance=new Dropzone("#j-dropzone",{url:rsMedia.url,autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#j-dropzone-tpl").html()}),this.dropzoneEvents(this.dropzoneInstance),this.cropping(this.dropzoneInstance))},dropzoneEvents:function(e){e.on("addedfile",function(e){if(e.type.indexOf("image/")<0)return this.removeFile(e),$("#alertModal").find(".alert-text").text("You can not upload this type of file!"),void $("#alertModal").modal("show");this.files.length>1&&this.removeFile(this.files[0]),$("#j-dropzone").parent().find(".btn.rs-media-removing").removeClass("disabled").prop("disabled",!1),$("#j-dropzone").parent().find(".btn.rs-media-cropping").removeClass("disabled").prop("disabled",!1)}),e.on("success",function(e,a){a=JSON.parse(a),a.success&&$(".img-select").val(a.data.file.url)}),$(document).on("click","button.rs-media-removing",function(a){if(e.removeAllFiles(),$(".img-select").val(""),$("#j-dropzone").parent().find(".btn.rs-media-removing").addClass("disabled").prop("disabled",!0),$("#j-dropzone").parent().find(".btn.rs-media-cropping").addClass("disabled").prop("disabled",!0),$("#image_delete").length<=0){var n=$("<input/>");n.attr("id","image_delete").attr("name","image_delete").attr("type","hidden").val(!0),$("#adminForm").append(n[0])}})},dropzonePreload:function(e,a){a&&(newfile=rsMedia.dataURItoBlob(a.blob),newfile.name=a.name,e.emit("thumbnail",a,a.url),e.addFile(newfile))},dataURItoBlob:function(e){for(var a=atob(e.split(",")[1]),n=new ArrayBuffer(a.length),i=new Uint8Array(n),t=0;t<a.length;t++)i[t]=a.charCodeAt(t);return new Blob([n],{type:"image/jpg"})},init:function(){$.fn.modalmanager.defaults.backdropLimit=1,this.dropzone(),this.galleryEvents()},galleryDropzone:function(){if($("#g-dropzone").length){var e=new Dropzone("#g-dropzone",{url:rsMedia.url,maxFiles:1,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#g-dropzone-tpl").html()});this.galleryDropzoneEvents(e)}},galleryEvents:function(e){void 0!==e&&""!=e||(e="galleryModal"),$(".choosing").on("click",function(a){a.preventDefault(),$("#"+e).modal("show")}),$(document).on("click","#"+e+" .img-obj",function(a){a.preventDefault(),$(this).hasClass("selected")?$(this).removeClass("selected"):($("#"+e+" .img-obj").removeClass("selected"),$(this).addClass("selected"),rsMedia.showInfoThumbnail(this)),rsMedia.resetInfoThumbnail(),rsMedia.toggleInsert()}),$("#"+e+" #type-filter").on("change",function(a){var n=$(this).val();return"all"==n?void $("#"+e+" .img-obj").parent().removeClass("hidden"):"attached"==n?void $("#"+e+" .img-obj > img:not([data-attached=true])").parent().parent().addClass("hidden"):($("#"+e+" .img-obj > img:not([data-media="+n+"])").parent().parent().addClass("hidden"),void $("#"+e+" .img-obj > img[data-media="+n+"]").parent().parent().removeClass("hidden"))}),$("#"+e+" .btn-insert").on("click",function(a){a.preventDefault();var n=$("#"+e+" .img-obj.selected").find("img").first(),i=n.attr("src");$("#"+e+" .img-select").val(i);var t=new XMLHttpRequest;t.open("GET",i),t.responseType="blob",t.send(),t.addEventListener("load",function(){var a=new FileReader;a.readAsDataURL(t.response),a.addEventListener("loadend",function(){var i=rsMedia.dataURItoBlob(a.result);i.name=n.attr("alt"),rsMedia.dropzoneInstance.addFile(i),$("#"+e).modal("hide")})})}),$("#"+e+" .btn-del-g").on("click",function(a){a.preventDefault(),$("#"+e+"Delete .btn-confirm-del-g").data("id",$(this).data("id")),$("#"+e+"Delete").modal("show")}),$("#"+e+"Delete .btn-confirm-del-g").on("click",function(a){a.preventDefault(),console.log("abc");var n=$(this).data("id");n&&$.ajax({url:rsMedia.delUrl,method:"post",data:{id:n}}).done(function(a){$("#"+e).find(".img-obj.selected").parent().remove(),$("#"+e+" .pv-wrapper").addClass("hidden")}).always(function(a){$("#"+e+"Delete").modal("hide")})})},galleryDropzoneEvents:function(e){e.on("sending",function(e,a,n){n.append("new",!0)}),e.on("success",function(a,n){n=JSON.parse(n);var a=n.data.file,i=$("#g-item-tpl").html(),t=$(i),o={};"image"==a.mime?(t.find("span.img-type").remove(),o=t.find("img.img-type")):(t.find("img.img-type").remove(),o=t.find("span.img-type")),o.attr("src","/"+a.url),o.attr("alt",a.name),o.data("id",a.id),o.data("size",a.size),o.data("dimension",a.dimension),o.data("media",a.media),t.find(".img-mime").data("mime",a.mime),""!=a.mime&&(o.find("i.fa").removeClass("fa-file-o").addClass("fa-file-"+a.mime+"-o"),t.find(".img-mime i.fa").removeClass("fa-file-o").addClass("fa-file-"+a.mime+"-o")),t.find(".img-name").text(a.name),$("#upload-lib .list-pane").append(t[0]),$('#g-tab a[href="#upload-lib"]').tab("show"),e.removeAllFiles()})},showInfoThumbnail:function(e){var a=$(e).find(".img-type"),n={id:a.data("id"),url:a.attr("src"),name:a.attr("alt"),size:a.data("size"),dimension:a.data("dimension")};$img=a.clone();var i=$(".preview-pane");i.find(".pv-img .img-type").remove(),i.find(".pv-img").append($img),i.find(".pv-zoom").attr("href",n.url),i.find(".pv-zoom").attr("data-title",n.name),i.find(".pv-link").attr("href",n.url),i.find(".pv-name").text(n.name),i.find(".pv-size").text(n.size),i.find(".pv-dimension").text(n.dimension),i.find(".pv-url").html('<input type="text" value="'+n.url+'" class="form-control" readonly="true">'),i.find(".pv-remove > a").data("id",n.id),i.find(".pv-wrapper").removeClass("hidden")},resetInfoThumbnail:function(){var e=$(".preview-pane");$(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden")},toggleInsert:function(){$(".img-obj.selected").length>0?$(".btn-insert").removeAttr("disabled"):$(".btn-insert").attr("disabled","true")}};