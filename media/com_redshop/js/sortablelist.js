!function(e){e.JSortableList=function(t,r,o,a,i,s){var d=this;"desc"!=o&&(o="asc");var n=e.extend({orderingIcon:"add-on",orderingWrapper:"input-prepend",orderingGroup:"sortable-group-id",sortableClassName:"dndlist-sortable",placeHolderClassName:"dnd-list-highlight dndlist-place-holder",sortableHandle:".sortable-handler"},i);e("tr",t).removeClass(n.sortableClassName).addClass(n.sortableClassName),e(t).parents("table").css("position","relative"),e(n.sortableHandle,t).css("cursor","move"),e("#"+r).attr("autocomplete","off");var l=e(n.sortableHandle,e(t)).length>0?n.sortableHandle:"";e(t).sortable({axis:"y",cursor:"move",handle:l,items:"tr."+n.sortableClassName,placeholder:n.placeHolderClassName,helper:function(t,r){return e(r).css({left:"0px"}),r.children().each(function(){e(this).width(e(this).width())}),e(r).children("td").addClass("dndlist-dragged-row"),r},start:function(r,o){d.sortableGroupId=o.item.attr(n.orderingGroup),d.sortableGroupId?d.sortableRange=e("tr["+n.orderingGroup+"="+d.sortableGroupId+"]"):d.sortableRange=e("."+n.sortableClassName),d.disableOtherGroupSort(r,o),s&&(d.hideChidlrenNodes(o.item.attr("item-id")),d.hideSameLevelChildrenNodes(o.item.attr("level")),e(t).sortable("refresh"))},stop:function(o,i){if(e("td",e(this)).removeClass("dndlist-dragged-row"),e(i.item).css({opacity:0}),e(i.item).animate({opacity:1},800,function(){e(i.item).css("opacity","")}),d.enableOtherGroupSort(o,i),d.rearrangeOrderingValues(d.sortableGroupId,i),a){d.cloneMarkedCheckboxes();var n=e("#"+r),l=e('input[name|="task"]',n);l.length&&l.detach(),e.post(a,n.serialize()),l.length&&l.appendTo(n),d.removeClonedCheckboxes()}d.disabledOrderingElements="",s&&(d.showChildrenNodes(i.item),d.showSameLevelChildrenNodes(i.item),e(t).sortable("refresh"))}}),this.hideChidlrenNodes=function(e){d.childrenNodes=d.getChildrenNodes(e),d.childrenNodes.hide()},this.showChildrenNodes=function(e){e.after(d.childrenNodes),d.childrenNodes.show(),d.childrenNodes=""},this.hideSameLevelChildrenNodes=function(t){d.sameLevelNodes=d.getSameLevelNodes(t),d.sameLevelNodes.each(function(){_childrenNodes=d.getChildrenNodes(e(this).attr("item-id")),_childrenNodes.addClass("child-nodes-tmp-hide"),_childrenNodes.hide()})},this.showSameLevelChildrenNodes=function(t){prevItem=t.prev(),prevItemChildrenNodes=d.getChildrenNodes(prevItem.attr("item-id")),prevItem.after(prevItemChildrenNodes),e("tr.child-nodes-tmp-hide").show().removeClass("child-nodes-tmp-hide"),d.sameLevelNodes=""},this.disableOtherGroupSort=function(r,o){if(d.sortableGroupId){var a=e("tr["+n.orderingGroup+"!="+d.sortableGroupId+"]",e(t));a.removeClass(n.sortableClassName).addClass("dndlist-group-disabled"),e(t).sortable("refresh")}},this.enableOtherGroupSort=function(r,o){var a=e("tr",e(t)).removeClass(n.sortableClassName);a.addClass(n.sortableClassName).removeClass("dndlist-group-disabled"),e(t).sortable("refresh")},this.disableOrderingControl=function(){e("."+n.orderingWrapper+" .add-on a",d.sortableRange).hide()},this.enableOrderingControl=function(){e("."+n.orderingWrapper+" .add-on a",d.disabledOrderingElements).show()},this.rearrangeOrderingControl=function(t,r){var o;t?d.sortableRange=e("tr["+n.orderingGroup+"="+t+"]"):d.sortableRange=e("."+n.sortableClassName),o=d.sortableRange;var a=o.length;a>1&&(o.each(function(){var t=e("."+n.orderingWrapper+" .add-on:first a",e(this)),r=e("."+n.orderingWrapper+" .add-on:last a",e(this));t.get(0)&&r.get(0)||(t.get(0)?(t.removeAttr("title"),t=e("."+n.orderingWrapper+" .add-on:first",e(this)).html(),r=t.replace("icon-uparrow","icon-downarrow"),r=r.replace(".orderup",".orderdown"),e("."+n.orderingWrapper+" .add-on:last",e(this)).html(r)):r.get(0)&&(r.removeAttr("title"),r=e("."+n.orderingWrapper+" .add-on:last",e(this)).html(),t=r.replace("icon-downarrow","icon-uparrow"),t=t.replace(".orderdown",".orderup"),e("."+n.orderingWrapper+" .add-on:first",e(this)).html(t)))}),e("."+n.orderingWrapper+" .add-on:first a",o[0]).remove(),e("."+n.orderingWrapper+" .add-on:last a",o[a-1]).remove())},this.rearrangeOrderingValues=function(t,r){var a;t?d.sortableRange=e("tr["+n.orderingGroup+"="+t+"]"):d.sortableRange=e("."+n.sortableClassName),a=d.sortableRange;var i=a.length;i>1&&(r.originalPosition.top>r.position.top?(r.item.position().top!=r.originalPosition.top&&e("[type=text]:hidden",r.item).attr("value",parseInt(e("[type=text]:hidden",r.item.next()).attr("value"))),e(a).each(function(){var t=e(this).position().top;if(r.item.get(0)!==e(this).get(0)&&t>r.item.position().top&&t<=r.originalPosition.top){if("asc"==o)var a=parseInt(e("[type=text]:hidden",e(this)).attr("value"))+1;else var a=parseInt(e("[type=text]:hidden",e(this)).attr("value"))-1;e("[type=text]:hidden",e(this)).attr("value",a)}})):r.originalPosition.top<r.position.top&&(r.item.position().top!=r.originalPosition.top&&e("[type=text]:hidden",r.item).attr("value",parseInt(e("[type=text]:hidden",r.item.prev()).attr("value"))),e(a).each(function(){var t=e(this).position().top;if(r.item.get(0)!==e(this).get(0)&&t<r.item.position().top&&t>=r.originalPosition.top){if("asc"==o)var a=parseInt(e("[type=text]:hidden",e(this)).attr("value"))-1;else var a=parseInt(e("[type=text]:hidden",e(this)).attr("value"))+1;e("[type=text]:hidden",e(this)).attr("value",a)}})))},this.cloneMarkedCheckboxes=function(){e('[name="order[]"]',e(t)).attr("name","order-tmp"),e("[type=checkbox]",d.sortableRange).each(function(){var t=e(this).clone();e(t).attr({checked:"checked",shadow:"shadow",id:""}),e("#"+r).append(e(t)),e('[name="order-tmp"]',e(this).parents("tr")).attr("name","order[]")})},this.removeClonedCheckboxes=function(){e("[shadow=shadow]").remove(),e('[name="order-tmp"]',e(t)).attr("name","order[]")},this.getChildrenNodes=function(t){return e('tr[parents~="'+t+'"]')},this.getSameLevelNodes=function(t){return e("tr[level="+t+"]")}}}(jQuery);