!function(o){var t="redshopMedia",n={uploadUrl:"index.php?option=com_redshop&view=media&task=ajaxUpload",deleteUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",allowedMime:"image/jpeg,image/jpg,image/png,image/gif",maxFileSize:2048,imageMaxWidth:2048,imageMaxHeight:2048,initFile:null,showMediaFiles:!1};function i(e,i){this._name=t,this._defaults=n,this.element=e,this.options=o.extend({},n,i),this.token=null,this.dropzoneInstance=null,this.$container=o(e),this.$dropzonePreview=this.$container.find(".rs-media-dropzone-preview"),this.$dropzoneForm=this.$container.find(".rs-media-dropzone-form"),this.$form=this.$container.closest("form"),this.$alertModal=this.$container.find(".rs-media-alert-modal"),this.$cropperModal=this.$container.find(".rs-media-cropper-modal"),this.$cropperButton=this.$container.find(".rs-media-cropper-btn"),this.$removeButton=this.$container.find(".rs-media-remove-btn"),this.$target=this.$container.find(".redshop-media-img-select"),this.$mediaFileButton=null,this.$mediaFileInsertButton=null,this.$mediaFileModal=null,this.$mediaFilePreview=null,this.$mediaFileDelModal=null,this.init()}i.prototype={init:function(){var e=this;if(this._initAttributes(),Dropzone.autoDiscover=!1,e.$dropzoneForm.length&&o("body").append(o(e.$dropzoneForm[0]).html()),o("#"+e.$container.data("id")+"-dropzone")&&(e.dropzoneInstance=new Dropzone("#"+e.$container.data("id")+"-dropzone",{url:e.options.uploadUrl,acceptedFiles:".png,.jpg,.jpeg,.bmp",autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:o(e.$dropzonePreview[0]).html(),resizeWidth:e.options.imageMaxWidth,resizeHeight:e.options.imageMaxHeight,resizeMethod:"contain"})),e.$alertModal.length&&(e.$alertModal=o(e.$alertModal[0])),e.$cropperButton.length&&(e.$cropperButton=o(e.$cropperButton[0])),e.$removeButton.length&&(e.$removeButton=o(e.$removeButton[0])),e.$target.length&&(e.$target=o(e.$target[0])),!0===e.options.showMediaFiles&&(e.$container.find(".rs-media-gallery-modal").length&&(e.$mediaFileModal=o(e.$container.find(".rs-media-gallery-modal")[0])),e.$container.find(".rs-media-gallery-preview").length&&(e.$mediaFilePreview=o(e.$container.find(".rs-media-gallery-preview")[0])),e.$container.find(".rs-media-gallery-delete-modal").length&&(e.$mediaFileDelModal=o(e.$container.find(".rs-media-gallery-delete-modal")[0])),e.$container.find(".rs-media-gallery-btn").length&&(e.$mediaFileButton=o(e.$container.find(".rs-media-gallery-btn")[0])),e.$container.find(".rs-media-gallery-insert-btn").length&&(e.$mediaFileInsertButton=o(e.$container.find(".rs-media-gallery-insert-btn")[0])),this._initMediaFileEvents()),this._initEvents(),null!=e.options.initFile){var i=e.dataURItoBlob(e.options.initFile.blob);i.name=e.options.initFile.name,e.dropzoneInstance.emit("thumbnail",e.options.initFile,e.options.initFile.url),e.dropzoneInstance.addFile(i)}},_initAttributes:function(){this.token=this.$container.attr("data-token")},_initEvents:function(){var d=this;d.dropzoneInstance.on("addedfile",function(e){d.validateFile(e)?(1<this.files.length&&this.removeFile(this.files[0]),d.$cropperButton.removeClass("disabled").prop("disabled",!1),d.$removeButton.removeClass("disabled").prop("disabled",!1),d.$container.find("#rs-media-img-delete").length&&d.$container.find("#rs-media-img-delete").remove()):this.removeFile(e)}),d.dropzoneInstance.on("success",function(e,i){(i=JSON.parse(i)).success&&d.$target.val(i.data.file.url)}),d.$removeButton.on("click",function(e){e.preventDefault(),d.dropzoneInstance.removeAllFiles(),d.$target.val(""),d.$cropperButton.addClass("disabled").prop("disabled",!0),d.$removeButton.addClass("disabled").prop("disabled",!0),d.$container.find(".ui-corner-all").length<=0&&jQuery(".ui-corner-all").remove();var i=null;d.$container.find("#rs-media-img-delete").length<=0&&((i=o("<input/>")).attr("id","rs-media-img-delete").attr("name",d.$container.data("id")+"_delete").attr("type","hidden"),o("#adminForm").append(i)),i.val(!0)}),d.$cropperButton.on("click",function(e){e.preventDefault();var i=d.dropzoneInstance.files[0];i?i.width<100||d.$cropperModal.modal("show"):showAlert("Please insert an image!!!")}),d.$cropperModal.on("shown.bs.modal",function(e){var t=d.dropzoneInstance.files[0],n=t.name,i=d.$cropperModal.find(".crop-upload"),a=d.$cropperModal.find(".image-container img").first(),o=new FileReader;o.onloadend=function(){a.attr("src",o.result),a.cropper("destroy").cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,viewMode:3,zoomable:!0})},t.preload?o.readAsDataURL(d.dataURItoBlob(t.blob)):o.readAsDataURL(t),i.off("click"),i.on("click",function(){var e=a.cropper("getCroppedCanvas").toDataURL(),i=d.dataURItoBlob(e);i.cropped=!0,i.name=n,d.dropzoneInstance.removeFile(t),d.dropzoneInstance.addFile(i),d.$cropperModal.modal("hide")})})},_initMediaFileEvents:function(){var a=this;a.$mediaFileButton.click(function(e){e.preventDefault(),a.$mediaFileModal.modal("show")}),a.$mediaFileModal.find(".img-obj").click(function(e){e.preventDefault(),o(this).hasClass("selected")?o(this).removeClass("selected"):(a.$mediaFileModal.find(".img-obj").removeClass("selected"),o(this).addClass("selected"),a.mediaFileShowInfor(this)),a.mediaFileResetPreview(),a.mediaFileToggleInsert()}),a.$mediaFileInsertButton.click(function(e){e.preventDefault();var t=a.$mediaFileModal.find(".img-obj.selected").find("img").first(),i=t.attr("src");a.$target.val(i);var n=new XMLHttpRequest;n.open("GET",i),n.responseType="blob",n.send(),n.addEventListener("load",function(){var i=new FileReader;i.readAsDataURL(this.response),i.addEventListener("loadend",function(){var e=a.dataURItoBlob(i.result);e.name=t.attr("alt"),a.dropzoneInstance.addFile(e),a.$mediaFileModal.modal("hide")})})}),a.$mediaFileModal.find(".btn-del-g").on("click",function(e){e.preventDefault(),a.$mediaFileDelModal.find(".btn-confirm-del-g").data("id",o(this).data("id")),a.$mediaFileDelModal.modal("show")}),a.$mediaFileDelModal.find(".btn-confirm-del-g").on("click",function(e){e.preventDefault();var i=o(this).data("id");i&&o.ajax({url:a.options.deleteUrl,method:"post",data:{id:i}}).done(function(e){a.$mediaFileModal.find(".img-obj.selected").parent().remove(),a.$mediaFileModal.find(".pv-wrapper").addClass("hidden")}).always(function(e){a.$mediaFileDelModal.modal("hide")})})},validateFile:function(e){var i=this;return e.size/1024>i.options.maxFileSize?(i.showAlert(Joomla.JText._("COM_REDSHOP_UPLOAD_FILE_TOO_BIG")),!1):-1!=i.options.allowedMime.indexOf(e.type)||(i.showAlert(Joomla.JText._("COM_REDSHOP_MEDIA_ERROR_FILE_UPLOAD_INVALID")),!1)},showAlert:function(e){this.$alertModal.find(".alert-text").text(e),this.$alertModal.modal("show"),o("#toolbar-apply button, #toolbar-save button, #toolbar-save-new button, #toolbar-save-copy button").attr("disabled",!1)},dataURItoBlob:function(e){for(var i=atob(e.split(",")[1]),t=new ArrayBuffer(i.length),n=new Uint8Array(t),a=0;a<i.length;a++)n[a]=i.charCodeAt(a);return new Blob([t],{type:"image/jpg"})},mediaFileShowInfor:function(e){if(!(this.$mediaFileModal.find(".preview-pane").length<=0)){var i=o(this.$mediaFileModal.find(".preview-pane")[0]),t=o(e).find(".img-type"),n={id:t.data("id"),url:t.attr("src"),name:t.attr("alt"),size:t.data("size"),dimension:t.data("dimension")},a=t.clone();i.find(".pv-img .img-type").remove(),i.find(".pv-img").append(a),i.find(".pv-zoom").attr("href",n.url),i.find(".pv-zoom").attr("data-title",n.name),i.find(".pv-link").attr("href",n.url),i.find(".pv-name").text(n.name),i.find(".pv-size").text(n.size),i.find(".pv-dimension").text(n.dimension),i.find(".pv-url").html('<input type="text" value="'+n.url+'" class="form-control" readonly="true">'),i.find(".pv-remove > a").data("id",n.id),i.find(".pv-wrapper").removeClass("hidden")}},mediaFileResetPreview:function(){if(!(this.$mediaFileModal.find(".preview-pane").length<=0)){var e=o(this.$mediaFileModal.find(".preview-pane")[0]);this.$mediaFileModal.find(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden")}},mediaFileToggleInsert:function(){null!=this.$mediaFileModal&&(0<this.$mediaFileModal.find(".img-obj.selected").length?this.$mediaFileInsertButton.removeAttr("disabled"):this.$mediaFileInsertButton.attr("disabled","true"))}},o.fn[t]=function(e){return this.each(function(){o.data(this,"plugin_"+t)||o.data(this,"plugin_"+t,new i(this,e))})}}(jQuery,(window,document));