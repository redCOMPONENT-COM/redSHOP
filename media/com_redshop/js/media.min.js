var rsMedia={url:"index.php?option=com_redshop&view=media&task=ajaxUpload",delUrl:"index.php?option=com_redshop&view=media&task=ajaxDelete",dropzoneFromHtml:$("#j-dropzone-form").html(),dropzoneInstance:{},galleryItems:[],cropping:function(r){$(document).on("click","button.rs-media-cropping",function(e){e.preventDefault();var n=r.files[0];if(!n)return $("#alertModal").find(".alert-text").text("Please insert an image!!!"),void $("#alertModal").modal("show");if(!(n.width<100)){var t=n.name,i=$("#cropModal"),a=i.find(".crop-upload"),o=$("<img />"),d=new FileReader;d.onloadend=function(){o.attr("src",d.result),i.find(".image-container").html(o),o.cropper({dragMode:"move",autoCropArea:.5,movable:!1,cropBoxResizable:!0,minContainerWidth:320,minContainerHeight:320,viewMode:3,zoomable:!1})},n.preload?d.readAsDataURL(rsMedia.dataURItoBlob(n.blob)):d.readAsDataURL(n),a.off("click"),i.modal("show"),i.trigger("resize"),console.log("abc"),a.on("click",function(){var e=o.cropper("getCroppedCanvas").toDataURL(),a=rsMedia.dataURItoBlob(e);a.cropped=!0,a.name=t,console.log(t),console.log(a),r.removeFile(n),r.addFile(a),i.modal("hide")})}})},dropzone:function(){Dropzone.autoDiscover=!1,$("body").append(this.dropzoneFromHtml),$("#j-dropzone").length&&(this.dropzoneInstance=new Dropzone("#j-dropzone",{url:rsMedia.url,autoProcessQueue:!0,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#j-dropzone-tpl").html()}),this.dropzoneEvents(this.dropzoneInstance),this.cropping(this.dropzoneInstance))},dropzoneEvents:function(n){n.on("addedfile",function(e){if(e.type.indexOf("image/")<0)return this.removeFile(e),$("#alertModal").find(".alert-text").text("You can not upload this type of file!"),void $("#alertModal").modal("show");1<this.files.length&&this.removeFile(this.files[0]),$("#j-dropzone").parent().find(".btn.rs-media-removing").removeClass("disabled").prop("disabled",!1),$("#j-dropzone").parent().find(".btn.rs-media-cropping").removeClass("disabled").prop("disabled",!1)}),n.on("success",function(e,a){(a=JSON.parse(a)).success&&$(".img-select").val(a.data.file.url)}),$(document).on("click","button.rs-media-removing",function(e){if(n.removeAllFiles(),$(".img-select").val(""),$("#j-dropzone").parent().find(".btn.rs-media-removing").addClass("disabled").prop("disabled",!0),$("#j-dropzone").parent().find(".btn.rs-media-cropping").addClass("disabled").prop("disabled",!0),$("#image_delete").length<=0){var a=$("<input/>");a.attr("id","image_delete").attr("name","image_delete").attr("type","hidden").val(!0),$("#adminForm").append(a[0])}})},dropzonePreload:function(e,a){a&&(newfile=rsMedia.dataURItoBlob(a.blob),newfile.name=a.name,e.emit("thumbnail",a,a.url),e.addFile(newfile))},dataURItoBlob:function(e){for(var a=atob(e.split(",")[1]),n=new ArrayBuffer(a.length),t=new Uint8Array(n),i=0;i<a.length;i++)t[i]=a.charCodeAt(i);return new Blob([n],{type:"image/jpg"})},init:function(){$.fn.modalmanager.defaults.backdropLimit=1,this.dropzone(),this.galleryEvents()},galleryDropzone:function(){if($("#g-dropzone").length){var e=new Dropzone("#g-dropzone",{url:rsMedia.url,maxFiles:1,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:$("#g-dropzone-tpl").html()});this.galleryDropzoneEvents(e)}},galleryEvents:function(i){void 0!==i&&""!=i||(i="galleryModal"),$(".choosing").on("click",function(e){e.preventDefault(),$("#"+i).modal("show")}),$(document).on("click","#"+i+" .img-obj",function(e){e.preventDefault(),$(this).hasClass("selected")?$(this).removeClass("selected"):($("#"+i+" .img-obj").removeClass("selected"),$(this).addClass("selected"),rsMedia.showInfoThumbnail(this)),rsMedia.resetInfoThumbnail(),rsMedia.toggleInsert()}),$("#"+i+" #type-filter").on("change",function(e){var a=$(this).val();"all"!=a?"attached"!=a?($("#"+i+" .img-obj > img:not([data-media="+a+"])").parent().parent().addClass("hidden"),$("#"+i+" .img-obj > img[data-media="+a+"]").parent().parent().removeClass("hidden")):$("#"+i+" .img-obj > img:not([data-attached=true])").parent().parent().addClass("hidden"):$("#"+i+" .img-obj").parent().removeClass("hidden")}),$("#"+i+" .btn-insert").on("click",function(e){e.preventDefault();var n=$("#"+i+" .img-obj.selected").find("img").first(),a=n.attr("src");$("#"+i+" .img-select").val(a);var t=new XMLHttpRequest;t.open("GET",a),t.responseType="blob",t.send(),t.addEventListener("load",function(){var a=new FileReader;a.readAsDataURL(t.response),a.addEventListener("loadend",function(){var e=rsMedia.dataURItoBlob(a.result);e.name=n.attr("alt"),rsMedia.dropzoneInstance.addFile(e),$("#"+i).modal("hide")})})}),$("#"+i+" .btn-del-g").on("click",function(e){e.preventDefault(),$("#"+i+"Delete .btn-confirm-del-g").data("id",$(this).data("id")),$("#"+i+"Delete").modal("show")}),$("#"+i+"Delete .btn-confirm-del-g").on("click",function(e){e.preventDefault(),console.log("abc");var a=$(this).data("id");a&&$.ajax({url:rsMedia.delUrl,method:"post",data:{id:a}}).done(function(e){$("#"+i).find(".img-obj.selected").parent().remove(),$("#"+i+" .pv-wrapper").addClass("hidden")}).always(function(e){$("#"+i+"Delete").modal("hide")})})},galleryDropzoneEvents:function(o){o.on("sending",function(e,a,n){n.append("new",!0)}),o.on("success",function(e,a){e=(a=JSON.parse(a)).data.file;var n=$("#g-item-tpl").html(),t=$(n),i={};(i="image"==e.mime?(t.find("span.img-type").remove(),t.find("img.img-type")):(t.find("img.img-type").remove(),t.find("span.img-type"))).attr("src","/"+e.url),i.attr("alt",e.name),i.data("id",e.id),i.data("size",e.size),i.data("dimension",e.dimension),i.data("media",e.media),t.find(".img-mime").data("mime",e.mime),""!=e.mime&&(i.find("i.fa").removeClass("fa-file-o").addClass("fa-file-"+e.mime+"-o"),t.find(".img-mime i.fa").removeClass("fa-file-o").addClass("fa-file-"+e.mime+"-o")),t.find(".img-name").text(e.name),$("#upload-lib .list-pane").append(t[0]),$('#g-tab a[href="#upload-lib"]').tab("show"),o.removeAllFiles()})},showInfoThumbnail:function(e){var a=$(e).find(".img-type"),n={id:a.data("id"),url:a.attr("src"),name:a.attr("alt"),size:a.data("size"),dimension:a.data("dimension")};$img=a.clone();var t=$(".preview-pane");t.find(".pv-img .img-type").remove(),t.find(".pv-img").append($img),t.find(".pv-zoom").attr("href",n.url),t.find(".pv-zoom").attr("data-title",n.name),t.find(".pv-link").attr("href",n.url),t.find(".pv-name").text(n.name),t.find(".pv-size").text(n.size),t.find(".pv-dimension").text(n.dimension),t.find(".pv-url").html('<input type="text" value="'+n.url+'" class="form-control" readonly="true">'),t.find(".pv-remove > a").data("id",n.id),t.find(".pv-wrapper").removeClass("hidden")},resetInfoThumbnail:function(){var e=$(".preview-pane");$(".img-obj.selected").length<=0&&e.find(".pv-wrapper").addClass("hidden")},toggleInsert:function(){0<$(".img-obj.selected").length?$(".btn-insert").removeAttr("disabled"):$(".btn-insert").attr("disabled","true")}};